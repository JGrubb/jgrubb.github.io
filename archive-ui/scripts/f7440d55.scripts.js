"use strict";angular.module("archiveApp",["ui.router","LocalStorageModule","chieffancypants.loadingBar","infinite-scroll","underscore"]).config(["$stateProvider","$urlRouterProvider",function(a){a.state("home",{url:"/",templateUrl:"views/main.html"}).state("list",{url:"/:collection",templateUrl:"views/list.html",controller:"ListController"}).state("detail",{url:"/detail/:id",templateUrl:"views/detail.html",controller:"DetailController"})}]);var underscore=angular.module("underscore",[]);underscore.factory("_",function(){return window._}),angular.module("archiveApp").controller("MainController",["$scope","Archive","Player",function(a,b,c){b.getIndex().then(function(b){a.bands=b}),a.player=c,a.limit=60,a.loadMore=function(){a.limit+=60}}]),angular.module("archiveApp").factory("Archive",["$http","$q","localStorageService",function(a,b,c){var d=c,e="https://archive.org/advancedsearch.php",f="https://archive.org/details/",g=function(){var c=b.defer();return d.get("idx")?c.resolve(d.get("idx")):a.get("index.json").success(function(a){c.resolve(a),d.set("idx",a)}),c.promise},h=function(c){var f=b.defer();return d.get(c)?f.resolve(d.get(c)):a({method:"JSONP",url:e,params:{q:'collection:"'+c+'"',"fl[]":["avg_rating","date","downloads","description","identifier","year","title"],"sort[]":["date desc","",""],rows:"10000",page:"1",indent:"yes",output:"json",callback:"JSON_CALLBACK",save:"yes"}}).success(function(a){f.resolve(a),d.set(c,a)}).error(function(a){f.reject(a)}),f.promise},i=function(c){var e=b.defer();return d.get(c)?e.resolve(d.get(c)):a({method:"JSONP",url:f+c,params:{output:"json",callback:"JSON_CALLBACK"}}).success(function(a){e.resolve(a),d.set(c,a)}),e.promise};return{getIndex:function(){return g()},getList:function(a){return h(a)},getShow:function(a){return i(a)}}}]),angular.module("archiveApp").controller("ListController",["$scope","Archive","$stateParams","_",function(a,b,c,d){var e;b.getList(c.collection).then(function(b){e=b.response.docs;var c=d.uniq(d.pluck(e,"year"));a.shows=e,a.years=c,a.years.push("All"),a.limit=20}),a.loadMore=function(){a.limit+=20},a.yearOf=c.year,a.setYear=function(b){a.limit=20,a.yearOf="All"===b?void 0:b}}]),angular.module("archiveApp").controller("DetailController",["$scope","Archive","$stateParams","Player",function(a,b,c,d){b.getShow(c.id).then(function(b){console.log(b),a.data=b,a.metadata=b.metadata,a.item=b.item,a.reviews=b.reviews,a.misc=b.misc,a.metakeys=Object.keys(a.metadata);for(var d in b.files)b.files[d].path=d,b.files[d].server=b.server,b.files[d].dir=b.dir,b.files[d].band=b.metadata.creator[0],b.files[d].date=b.metadata.date[0],b.files[d].orig=c.id,b.files[d].collection=b.metadata.collection[0];var e=_.filter(b.files,function(a){return!a.hasOwnProperty("length")}),f=_.filter(b.files,function(a){return"VBR MP3"===a.format});a.notTracks=e,a.tracks=f}),a.addShow=function(a){for(var b=0,c=a.length;c>b;b++)d.playlist.add(a[b])}}]),angular.module("archiveApp").directive("player",function(){return{template:"<div></div>",restrict:"EA",link:function(a,b){b.text("this is the player directive")}}}),angular.module("archiveApp").factory("Player",["audio","$rootScope","localStorageService",function(a,b,c){var d,e,f=!1,g=c,h=g.get("playlist")||[];return d={playlist:h,current:e,playing:!1,play:function(b){var c=h,i=e||g.get("playlist.current");c.length&&(angular.isDefined(b)&&(e=b,g.set("playlist.current",b)),f||(a.src="http://"+c[i].server+c[i].dir+c[i].path),a.play(),d.playing=!0,f=!1)},pause:function(){d.playing&&(a.pause(),d.playing=!1,f=!0)},reset:function(){d.pause(),e=0,g.set("playlist.current",d.current)},next:function(){h.length&&(f=!1,h.length>e+1?e++:e=0,console.log("next",e),g.set("playlist.current",e),d.playing&&d.play())},previous:function(){h.length&&(f=!1,e>0?e--:e=h.length-1,console.log("prev",e),g.set("playlist.current",e),d.playing&&d.play())}},h.add=function(a){-1==h.indexOf(a)&&(h.push(a),g.set("playlist",h))},h.remove=function(a){var b=h.indexOf(a);b==e&&d.reset(),h.splice(b,1),g.set("playlist",h)},a.addEventListener("ended",function(){b.$apply(d.next)},!1),d}]),angular.module("archiveApp").factory("audio",["$document",function(a){var b=a[0].createElement("audio");return b}]);