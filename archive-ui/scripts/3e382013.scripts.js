"use strict";angular.module("archiveApp",["ui.router","LocalStorageModule","chieffancypants.loadingBar","infinite-scroll","mm.foundation","underscore"]).config(["$stateProvider","$urlRouterProvider",function(a){a.state("home",{url:"/",templateUrl:"views/main.html"}).state("list",{url:"/:collection",templateUrl:"views/list.html",controller:"ListController"}).state("detail",{url:"/detail/:id",templateUrl:"views/detail.html",controller:"DetailController"})}]);var underscore=angular.module("underscore",[]);underscore.factory("_",function(){return window._}),angular.module("archiveApp").controller("MainController",["$scope","Archive","Player",function(a,b,c){b.getIndex().then(function(b){a.bands=b}),a.player=c,a.limit=60,a.loadMore=function(){a.limit+=60}}]),angular.module("archiveApp").factory("Archive",["$http","$q","localStorageService",function(a,b,c){var d=c,e="https://archive.org/advancedsearch.php",f="https://archive.org/details/",g=function(){var c=b.defer();return d.get("idx")?c.resolve(d.get("idx")):a.get("index.json").success(function(a){c.resolve(a),d.set("idx",a)}),c.promise},h=function(c){var f=b.defer();return d.get(c)?f.resolve(d.get(c)):a({method:"JSONP",url:e,params:{q:'collection:"'+c+'"',"fl[]":["avg_rating","date","downloads","description","identifier","year","title"],"sort[]":["date desc","",""],rows:"10000",page:"1",indent:"yes",output:"json",callback:"JSON_CALLBACK",save:"yes"}}).success(function(a){f.resolve(a),d.set(c,a)}).error(function(a){f.reject(a)}),f.promise},i=function(c){var e=b.defer();return d.get(c)?e.resolve(d.get(c)):a({method:"JSONP",url:f+c,params:{output:"json",callback:"JSON_CALLBACK"}}).success(function(a){e.resolve(a),d.set(c,a)}),e.promise};return{getIndex:function(){return g()},getList:function(a){return h(a)},getShow:function(a){return i(a)}}}]),angular.module("archiveApp").controller("ListController",["$scope","Archive","$stateParams","_",function(a,b,c,d){var e;b.getList(c.collection).then(function(b){e=b.response.docs;var c=d.uniq(d.pluck(e,"year"));a.shows=e,a.years=c,a.years.push("All"),a.limit=20}),a.loadMore=function(){a.limit+=20},a.yearOf=c.year,a.setYear=function(b){a.limit=20,a.yearOf="All"===b?void 0:b}}]),angular.module("archiveApp").controller("DetailController",["$scope","Archive","$stateParams",function(a,b,c){b.getShow(c.id).then(function(b){a.data=b,a.metadata=b.metadata,a.item=b.item,a.reviews=b.reviews,a.misc=b.misc,a.hasMp3="1"===b.metadata.mas_mp3;for(var c in b.files)b.files[c].path=c,b.files[c].server=b.server,b.files[c].dir=b.dir;var d=_.filter(b.files,function(a){return"undefined"==typeof a.track}),e=_.filter(b.files,function(a){return"VBR MP3"===a.format||"Ogg Vorbis"===a.format});e=_.groupBy(e,function(a){return a.track}),a.notTracks=d,a.tracks=e})}]),angular.module("archiveApp").directive("player",function(){return{template:"<div></div>",restrict:"EA",link:function(a,b){b.text("this is the player directive")}}}),angular.module("archiveApp").factory("Player",["audio","$rootScope",function(a,b){var c,d=[],e=!1,f=0;return c={playlist:d,current:f,playing:!1,play:function(b){d.length&&(angular.isDefined(b)&&(c.current=b),e||(a.src="http://"+d[c.current][0].server+d[c.current][0].dir+d[c.current][0].path),a.play(),c.playing=!0,e=!1)},pause:function(){c.playing&&(a.pause(),c.playing=!1,e=!0)},reset:function(){c.pause(),f=0},next:function(){d.length&&(e=!1,d[f][0].length>f+1?f++:f=0,c.playing&&c.play())},previous:function(){d.length&&(e=!1,f>0?f--:f.track=d.length-1,c.playing&&c.play())}},d.add=function(a){-1==d.indexOf(a)&&(d.push(a),console.log(d))},d.remove=function(a){var b=d.indexOf(a);b==f&&c.reset(),d.splice(b,1)},a.addEventListener("ended",function(){b.$apply(c.next)},!1),c}]),angular.module("archiveApp").factory("audio",["$document",function(a){var b=a[0].createElement("audio");return b}]);